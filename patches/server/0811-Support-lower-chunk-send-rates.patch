From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: MartijnMuijsers <martijnmuijsers@live.nl>
Date: Wed, 22 Sep 2021 15:38:51 +0200
Subject: [PATCH] Support lower chunk send rates


diff --git a/src/main/java/io/papermc/paper/chunk/PlayerChunkLoader.java b/src/main/java/io/papermc/paper/chunk/PlayerChunkLoader.java
index ade1fb45f277add58a21d9ffb99b34c6c1ff8429..2e937224e66c6f3edb37857cd7d567e337102177 100644
--- a/src/main/java/io/papermc/paper/chunk/PlayerChunkLoader.java
+++ b/src/main/java/io/papermc/paper/chunk/PlayerChunkLoader.java
@@ -354,13 +354,15 @@ public final class PlayerChunkLoader {
     // Martijn in Paper start - per-player chunk send rate
     protected long getTargetSendPerPlayerAddend(ServerPlayer player) {
         final double chunkSendRate = player.getBukkitEntity().getTargetChunkSendRate();
-        // disable the limit for any given negative rate (with -1 the intended value to denote this)
+        // disable the limit for any given negative rate (with -1 the intended value to denote this, and 0L the appropriate output of this method in that case)
         return chunkSendRate < 0 ? 0L : (long) Math.round(1.0e9 / chunkSendRate);
     }
     // Martijn in Paper end - per-player chunk send rate
 
     protected long getMaxSendAddend() {
-        return PaperConfig.globalMaxChunkSendRate <= 1.0 ? 0L : (long)Math.round(1.0e9 / PaperConfig.globalMaxChunkSendRate);
+        // Martijn in Paper start - allow low chunk send rates
+        return PaperConfig.globalMaxChunkSendRate < 0 ? 0L : (long)Math.round(1.0e9 / PaperConfig.globalMaxChunkSendRate);
+        // Martijn in Paper end - allow low chunk send rates
     }
 
     public void onChunkPlayerTickReady(final int chunkX, final int chunkZ) {
diff --git a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
index 0990142c93d3a60cd736b8fc80e6f5a17e35ae6d..9139e8bbe65423c78c517f7c6535b00726f42f95 100644
--- a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
+++ b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
@@ -632,7 +632,7 @@ public class CraftPlayer extends CraftHumanEntity implements Player {
         final Double playerTargetChunkSendRate = this.getHandle().targetChunkSendRate;
         final double effectiveTargetChunkSendRate = playerTargetChunkSendRate == null ? PaperConfig.playerTargetChunkSendRate : playerTargetChunkSendRate;
         // Make sure the returned rate is -1, or >= 1
-        return effectiveTargetChunkSendRate < 0 ? -1 : (effectiveTargetChunkSendRate <= 1 ? 1 : effectiveTargetChunkSendRate);
+        return effectiveTargetChunkSendRate < 0 ? -1 : Math.max(effectiveTargetChunkSendRate, 1.0e-6);
     }
 
     @Override
